{"version":3,"file":"index.js","sources":["../src/Notifier.ts","../src/Subscriber.ts","../src/Store.ts"],"sourcesContent":["type Listener = () => void\n\nexport class Notifier {\n  private _listens: Listener[] = []\n\n  get hasListen(): boolean {\n    return Boolean(this._listens.length)\n  }\n\n  addListen(listener: Listener): () => void {\n    this._listens.push(listener)\n    return () => {\n      this._listens.splice(this._listens.indexOf(listener), 1)\n    }\n  }\n\n  protected notify(): void {\n    this._listens.forEach((listener) => listener())\n  }\n}\n\nexport class ValueChanged<V> extends Notifier {\n  constructor(private _value: V) {\n    super()\n  }\n\n  get value(): V {\n    return this._value\n  }\n\n  set value(value: V) {\n    if (this._value === value) return\n    this._value = value\n    this.notify()\n  }\n}\n","import { SetStateAction } from 'react'\nimport { ValueChanged } from './Notifier'\nimport { ShallowSetStateAction, StoreApi } from './type'\n\nexport class Subscriber<V, A> extends ValueChanged<V> {\n  action: A\n\n  get api() {\n    return {\n      get: () => this.value,\n      set: (value: SetStateAction<V>) => {\n        if (value instanceof Function) this.value = value(this.value)\n        else this.value = value\n      },\n      shallow: (value: ShallowSetStateAction<V>) => {\n        let nextValue: Partial<V>\n        if (value instanceof Function) nextValue = value(this.value)\n        else nextValue = value\n        const changed = Object.keys(nextValue).find((key) => {\n          return nextValue[key] !== this.value[key]\n        })\n        if (changed) {\n          this.value = Object.assign({}, this.value, nextValue)\n        }\n      }\n    }\n  }\n\n  constructor(value: V, createAction: (api: StoreApi<V>) => A) {\n    super(value)\n    this.action = createAction(this.api)\n  }\n}\n","import {\n  Context,\n  createContext,\n  createElement,\n  ReactNode,\n  useContext,\n  useEffect,\n  useState\n} from 'react'\n\nimport {\n  StoreProps,\n  HookSelector,\n  ContainerLifeCycle,\n  ContainerLifePoint,\n  ActionCreator\n} from './type'\nimport { Subscriber } from './Subscriber'\n\nexport class Store<State, Action> {\n  private Context: Context<Subscriber<State, Action>>\n  private _createAction: ActionCreator<State, Action>\n\n  constructor({ state, action, name }: StoreProps<State, Action>) {\n    if (typeof action === 'function') {\n      this._createAction = action\n    } else {\n      this._createAction = (api) => {\n        const actions = {} as Action\n        Object.keys(action).forEach((key) => {\n          actions[key] = action[key](api)\n        })\n        return actions\n      }\n    }\n    this.Context = createContext(new Subscriber(state, this._createAction))\n    this.Context.displayName = name\n  }\n\n  createContainer(cycle: ContainerLifeCycle<State, Action> = {}) {\n    const { Context, _createAction } = this\n    type Props = { state: State; children: ReactNode }\n\n    const firePoint = (\n      store: Subscriber<State, Action>,\n      fire?: ContainerLifePoint<State, Action>\n    ) => {\n      fire && fire(store.api, store.action)\n    }\n\n    return ({ children, state }: Props) => {\n      const [store] = useState(() => new Subscriber(state, _createAction))\n\n      useEffect(() => {\n        firePoint(store, cycle.create)\n        return () => firePoint(store, cycle.dispose)\n      }, [store])\n\n      useEffect(() => {\n        if (store.value !== state) {\n          store.value = state\n          firePoint(store, cycle.update)\n        }\n      }, [state, store])\n\n      return createElement(Context.Provider, { value: store, children })\n    }\n  }\n\n  createSubscriber() {\n    const { Context } = this\n    type Props = { children: (state: State, action: Action) => ReactNode }\n\n    return ({ children }: Props) => {\n      const context = useContext(Context)\n      return children(context.value, context.action)\n    }\n  }\n\n  createHook<Value = State, Flags extends any[] = never>(\n    selector?: HookSelector<State, Value, Flags>\n  ) {\n    const { Context } = this\n    type Select = (state: State, ...flags: Flags) => Value\n    const select = (selector || ((v) => v)) as Select\n    return (...flags: Flags): [Value, Action] => {\n      const store = useContext(Context)\n      const [state, setState] = useState(() => select(store.value, ...flags))\n\n      useEffect(() => {\n        setState(select(store.value, ...flags))\n        return store.addListen(() => setState(select(store.value, ...flags)))\n      }, [store, ...flags])\n\n      return [state, store.action]\n    }\n  }\n\n  createHookAction() {\n    return () => useContext(this.Context).action\n  }\n}\n"],"names":["Notifier","addListen","listener","_listens","push","splice","indexOf","notify","forEach","Boolean","length","ValueChanged","_value","value","Subscriber","createAction","action","api","get","set","Function","shallow","nextValue","changed","Object","keys","find","key","assign","Store","state","name","_createAction","actions","Context","createContext","displayName","createContainer","cycle","firePoint","store","fire","children","useState","useEffect","create","dispose","update","createElement","Provider","createSubscriber","context","useContext","createHook","selector","select","v","flags","setState","createHookAction"],"mappings":"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"}