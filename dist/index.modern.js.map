{"version":3,"file":"index.modern.js","sources":["../src/Notifier.ts","../src/Subscriber.ts","../src/Store.ts"],"sourcesContent":["type Listener = () => void\n\nexport class Notifier {\n  private _listens: Listener[] = []\n\n  get hasListen(): boolean {\n    return Boolean(this._listens.length)\n  }\n\n  addListen(listener: Listener): () => void {\n    this._listens.push(listener)\n    return () => {\n      this._listens.splice(this._listens.indexOf(listener), 1)\n    }\n  }\n\n  protected notify(): void {\n    this._listens.forEach((listener) => listener())\n  }\n}\n\nexport class ValueChanged<V> extends Notifier {\n  constructor(private _value: V) {\n    super()\n  }\n\n  get value(): V {\n    return this._value\n  }\n\n  set value(value: V) {\n    if (this._value === value) return\n    this._value = value\n    this.notify()\n  }\n}\n","import { SetStateAction } from 'react'\nimport { ValueChanged } from './Notifier'\nimport { ShallowSetStateAction, StoreApi } from './type'\n\nexport class Subscriber<V, A> extends ValueChanged<V> {\n  action: A\n\n  get api() {\n    return {\n      get: () => this.value,\n      set: (value: SetStateAction<V>) => {\n        if (value instanceof Function) this.value = value(this.value)\n        else this.value = value\n      },\n      shallow: (value: ShallowSetStateAction<V>) => {\n        let nextValue: Partial<V>\n        if (value instanceof Function) nextValue = value(this.value)\n        else nextValue = value\n        const changed = Object.keys(nextValue).find((key) => {\n          return nextValue[key] !== this.value[key]\n        })\n        if (changed) {\n          this.value = Object.assign({}, this.value, nextValue)\n        }\n      }\n    }\n  }\n\n  constructor(value: V, createAction: (api: StoreApi<V>) => A) {\n    super(value)\n    this.action = createAction(this.api)\n  }\n}\n","import {\n  Component,\n  Context,\n  createContext,\n  createElement,\n  useContext,\n  useEffect,\n  useState\n} from 'react'\n\nimport {\n  StoreProps,\n  HookSelector,\n  ContainerLifeCycle,\n  ContainerLifePoint,\n  ActionCreator\n} from './type'\nimport { Subscriber } from './Subscriber'\n\nexport class Store<State, Action> {\n  private Context: Context<Subscriber<State, Action>>\n  private _createAction: ActionCreator<State, Action>\n\n  constructor({ state, action, name }: StoreProps<State, Action>) {\n    if (typeof action === 'function') {\n      this._createAction = action\n    } else {\n      this._createAction = (api) => {\n        const actions = {} as Action\n        Object.keys(action).forEach((key) => {\n          actions[key] = action[key](api)\n        })\n        return actions\n      }\n    }\n    this.Context = createContext(new Subscriber(state, this._createAction))\n    this.Context.displayName = name\n  }\n\n  createContainer(cycle: ContainerLifeCycle<State, Action> = {}) {\n    const { Context, _createAction } = this\n    type Props = { state: State }\n\n    return class extends Component<Props> {\n      static displayName = Context.displayName\n      store: Subscriber<State, Action>\n      constructor(props: Props) {\n        super(props)\n        this.store = new Subscriber(props.state, _createAction)\n        this.firePoint(cycle.create)\n      }\n\n      firePoint = (fire?: ContainerLifePoint<State, Action>) => {\n        fire && fire(this.store.api, this.store.action)\n      }\n\n      shouldComponentUpdate(next: Props) {\n        if (next.state !== this.props.state) {\n          this.store.value = next.state\n          this.firePoint(cycle.update)\n          return true\n        }\n        return false\n      }\n\n      componentWillUnmount() {\n        this.firePoint(cycle.dispose)\n      }\n\n      render() {\n        const { children } = this.props\n        return createElement(Context.Provider, { value: this.store, children })\n      }\n    }\n  }\n\n  createHook<Value = State, Flag = void>(\n    selector?: HookSelector<State, Value, Flag>\n  ) {\n    const { Context } = this\n    type Select = (state: State, flag: Flag) => Value\n    const select = (selector || ((v) => v)) as Select\n    return (flag: Flag): [Value, Action] => {\n      const store = useContext(Context)\n      const [state, setState] = useState(() => select(store.value, flag))\n\n      useEffect(() => {\n        setState(select(store.value, flag))\n        return store.addListen(() => setState(select(store.value, flag)))\n      }, [store, flag])\n\n      return [state, store.action]\n    }\n  }\n\n  createAction() {\n    return () => useContext(this.Context).action\n  }\n}\n"],"names":["Notifier","addListen","listener","_listens","push","splice","indexOf","notify","forEach","Boolean","length","ValueChanged","_value","value","Subscriber","createAction","action","api","get","set","Function","shallow","nextValue","changed","Object","keys","find","key","assign","Store","state","name","_createAction","actions","Context","createContext","displayName","createContainer","cycle","props","fire","store","firePoint","create","shouldComponentUpdate","next","update","componentWillUnmount","dispose","render","children","createElement","Provider","Component","_a","createHook","selector","select","v","flag","useContext","useState","setState","useEffect"],"mappings":"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"}